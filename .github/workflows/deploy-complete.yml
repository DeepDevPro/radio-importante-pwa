# GitHub Actions - Deploy Completo (Frontend + Backend)
name: ðŸš€ Deploy Complete Stack

on:
  push:
    branches: [main]
  workflow_dispatch: # Permite trigger manual
    inputs:
      deploy_backend:
        description: 'Deploy backend tambÃ©m?'
        required: false
        default: 'true'
        type: boolean
      deploy_frontend:
        description: 'Deploy frontend tambÃ©m?'
        required: false
        default: 'true'
        type: boolean

jobs:
  changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          backend:
            - 'backend/**'
          frontend:
            - 'src/**'
            - 'public/**'
            - 'index.html'
            - 'package.json'
            - 'vite.config.ts'

  deploy-backend:
    name: ðŸ—ï¸ Deploy Backend
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event.inputs.deploy_backend == 'true'
    defaults:
      run:
        working-directory: ./backend
    outputs:
      backend_url: ${{ steps.get-url.outputs.url }}
        
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸŸ¢ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: './backend/package-lock.json'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ”§ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2
        
    - name: ðŸ› ï¸ Install EB CLI
      run: pip install awsebcli
        
    - name: ðŸš€ Deploy to Elastic Beanstalk
      run: |
        echo "=== Iniciando Deploy Backend ==="
        
        # ConfiguraÃ§Ã£o AWS
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        S3_BUCKET="elasticbeanstalk-us-west-2-$ACCOUNT_ID"
        VERSION_LABEL="v1.2.1-$(date +%s)"
        
        echo "Account ID: $ACCOUNT_ID"
        echo "S3 Bucket: $S3_BUCKET"
        echo "Version Label: $VERSION_LABEL"
        
        # Limpar e criar package otimizado
        echo "Criando package..."
        rm -f deploy-package.zip
        
        # Criar ZIP com exclusÃµes mais especÃ­ficas
        zip -r deploy-package.zip . \
          -x "*.git*" \
             "node_modules/*" \
             "*.log" \
             "*.tmp" \
             "*.zip" \
             ".DS_Store" \
             "*.swp" \
             ".env" \
             "test-api.sh" \
             "eb-init.sh" \
             ".elasticbeanstalk/*"
        
        echo "Package criado: $(ls -lh deploy-package.zip | awk '{print $5}')"
        
        # Upload para S3
        echo "Fazendo upload para S3..."
        aws s3 cp deploy-package.zip s3://$S3_BUCKET/radio-importante-backend/deploy-package.zip
        
        # Verificar upload
        if aws s3 ls s3://$S3_BUCKET/radio-importante-backend/deploy-package.zip; then
          echo "âœ… Upload para S3 realizado com sucesso"
        else
          echo "âŒ Falha no upload para S3"
          exit 1
        fi
        
        # Verificar se application version jÃ¡ existe
        echo "Verificando se versÃ£o $VERSION_LABEL jÃ¡ existe..."
        if aws elasticbeanstalk describe-application-versions \
           --application-name radio-importante-backend \
           --version-labels $VERSION_LABEL \
           --region us-west-2 \
           --query 'ApplicationVersions[0].VersionLabel' \
           --output text 2>/dev/null | grep -q "$VERSION_LABEL"; then
          echo "âš ï¸ VersÃ£o $VERSION_LABEL jÃ¡ existe, usando versÃ£o existente"
        else
          echo "Criando nova versÃ£o da aplicaÃ§Ã£o..."
          aws elasticbeanstalk create-application-version \
            --application-name radio-importante-backend \
            --version-label $VERSION_LABEL \
            --description "Deploy TAG v1.2.1 - $(date)" \
            --source-bundle S3Bucket="$S3_BUCKET",S3Key="radio-importante-backend/deploy-package.zip" \
            --region us-west-2
          
          # Aguardar processamento com timeout maior
          echo "Aguardando processamento da versÃ£o..."
          WAIT_COUNT=0
          MAX_WAIT=30
          
          while [ $WAIT_COUNT -lt $MAX_WAIT ]; do
            STATUS=$(aws elasticbeanstalk describe-application-versions \
              --application-name radio-importante-backend \
              --version-labels $VERSION_LABEL \
              --region us-west-2 \
              --query 'ApplicationVersions[0].Status' \
              --output text 2>/dev/null || echo "NOTFOUND")
            
            echo "Status da versÃ£o: $STATUS (tentativa $((WAIT_COUNT+1))/$MAX_WAIT)"
            
            if [ "$STATUS" = "PROCESSED" ]; then
              echo "âœ… VersÃ£o processada com sucesso"
              break
            elif [ "$STATUS" = "FAILED" ]; then
              echo "âŒ Falha no processamento da versÃ£o"
              # Mostrar detalhes do erro
              aws elasticbeanstalk describe-application-versions \
                --application-name radio-importante-backend \
                --version-labels $VERSION_LABEL \
                --region us-west-2
              exit 1
            fi
            
            WAIT_COUNT=$((WAIT_COUNT+1))
            sleep 10
          done
          
          if [ $WAIT_COUNT -eq $MAX_WAIT ]; then
            echo "âŒ Timeout aguardando processamento da versÃ£o"
            exit 1
          fi
        fi
        
        # Deploy para o environment
        echo "Fazendo deploy para o environment..."
        aws elasticbeanstalk update-environment \
          --environment-name radio-importante-backend-prod \
          --version-label $VERSION_LABEL \
          --region us-west-2
        
        # Aguardar deploy
        echo "Aguardando deploy completar..."
        aws elasticbeanstalk wait environment-updated \
          --environment-names radio-importante-backend-prod \
          --region us-west-2 \
          --waiter-config maxAttempts=60,delay=30
        
        echo "âœ… Deploy concluÃ­do com sucesso!"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        
    - name: ðŸ” Get backend URL
      id: get-url
      run: |
        echo "Obtendo URL do environment..."
        
        # Usar AWS CLI diretamente para obter a URL
        URL=$(aws elasticbeanstalk describe-environments 
          --environment-names radio-importante-backend-prod 
          --region us-west-2 
          --query 'Environments[0].CNAME' 
          --output text 2>/dev/null || echo "")
        
        if [ -z "$URL" ] || [ "$URL" = "None" ]; then
          echo "âŒ NÃ£o foi possÃ­vel obter a URL do environment"
          echo "Tentando obter informaÃ§Ãµes do environment..."
          aws elasticbeanstalk describe-environments 
            --environment-names radio-importante-backend-prod 
            --region us-west-2
          exit 1
        fi
        
        # Adicionar protocolo se nÃ£o tiver
        if [[ ! "$URL" =~ ^https?:// ]]; then
          URL="http://$URL"
        fi
        
        echo "âœ… Backend URL: $URL"
        echo "backend_url=$URL" >> $GITHUB_OUTPUT

  deploy-frontend:
    name: ðŸŽ¨ Deploy Frontend
    runs-on: ubuntu-latest
    needs: [changes, deploy-backend]
    if: always() && (needs.changes.outputs.frontend == 'true' || github.event.inputs.deploy_frontend == 'true')
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ”§ Configure backend URL (if deployed)
      run: |
        if [ -n "${{ needs.deploy-backend.outputs.backend_url }}" ]; then
          echo "Configuring frontend to use backend: ${{ needs.deploy-backend.outputs.backend_url }}"
          # Aqui podemos adicionar lÃ³gica para atualizar config do frontend
        fi
      
    - name: ðŸ—ï¸ Build frontend
      run: npm run build
      
    - name: ðŸ”§ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2
        
    - name: ðŸŒ Deploy to S3
      run: |
        # Use bucket padrÃ£o se S3_BUCKET_NAME nÃ£o estiver definido
        S3_BUCKET="${{ secrets.S3_BUCKET_NAME }}"
        if [ -z "$S3_BUCKET" ]; then
          S3_BUCKET="radio-importante-frontend"
          echo "âš ï¸ S3_BUCKET_NAME nÃ£o definido, usando bucket padrÃ£o: $S3_BUCKET"
        fi
        
        echo "Deploying to S3 bucket: $S3_BUCKET"
        aws s3 sync dist/ s3://$S3_BUCKET --delete
        
    - name: ðŸ”„ Invalidate CloudFront (if exists)
      run: |
        if [ -n "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
        fi
      continue-on-error: true

  test-integration:
    name: ðŸ§ª Integration Tests
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always() && needs.deploy-backend.result == 'success'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ§ª Test backend health
      run: |
        BACKEND_URL="${{ needs.deploy-backend.outputs.backend_url }}"
        echo "Testing backend at: $BACKEND_URL"
        
        # Health check
        curl -f "$BACKEND_URL/health"
        
        # API endpoints
        curl -f "$BACKEND_URL/api/catalog"
        
        echo "âœ… All backend tests passed!"
        
    - name: ðŸŒ Test frontend
      run: |
        # Use bucket padrÃ£o se S3_BUCKET_NAME nÃ£o estiver definido
        S3_BUCKET="${{ secrets.S3_BUCKET_NAME }}"
        if [ -z "$S3_BUCKET" ]; then
          S3_BUCKET="radio-importante-frontend"
          echo "âš ï¸ S3_BUCKET_NAME nÃ£o definido, usando bucket padrÃ£o: $S3_BUCKET"
        fi
        
        FRONTEND_URL="https://$S3_BUCKET.s3-website-us-west-2.amazonaws.com"
        echo "Testing frontend at: $FRONTEND_URL"
        
        # Test if frontend is accessible
        curl -f "$FRONTEND_URL" | head -n 20
        
        echo "âœ… Frontend deployment successful!"

  notify:
    name: ðŸ“¢ Notify Success
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, test-integration]
    if: always()
    
    steps:
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Backend" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.deploy-backend.result }}" == "success" ]; then
          echo "- âœ… **Backend**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ **URL**: ${{ needs.deploy-backend.outputs.backend_url }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â­ï¸ **Backend**: Skipped or failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Frontend" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
          echo "- âœ… **Frontend**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
          # Use bucket padrÃ£o se S3_BUCKET_NAME nÃ£o estiver definido
          S3_BUCKET="${{ secrets.S3_BUCKET_NAME }}"
          if [ -z "$S3_BUCKET" ]; then
            S3_BUCKET="radio-importante-frontend"
          fi
          echo "- ðŸŒ **URL**: https://$S3_BUCKET.s3-website-us-west-2.amazonaws.com" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â­ï¸ **Frontend**: Skipped or failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tests" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.test-integration.result }}" == "success" ]; then
          echo "- âœ… **Integration tests**: All passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ **Integration tests**: Some issues detected" >> $GITHUB_STEP_SUMMARY
        fi
