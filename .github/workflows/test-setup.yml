name: ðŸ§ª Test GitHub Actions Setup

on:
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Test Level'
        required: true
        default: 'basic'
        type: choice
        options:
        - basic
        - full
        - secrets-only

jobs:
  test-secrets:
    name: ðŸ” Test Secrets Configuration
    runs-on: ubuntu-latest
    outputs:
      secrets-status: ${{ steps.check.outputs.status }}
    
    steps:
    - name: ðŸ“‹ Check Required Secrets
      id: check
      run: |
        echo "Checking required secrets..."
        
        # Check AWS credentials
        if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
          echo "âŒ AWS_ACCESS_KEY_ID not configured"
          echo "status=missing-aws" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
          echo "âŒ AWS_SECRET_ACCESS_KEY not configured"
          echo "status=missing-aws" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        if [ -z "${{ secrets.S3_BUCKET_NAME }}" ]; then
          echo "âŒ S3_BUCKET_NAME not configured"
          echo "status=missing-s3" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "âœ… All required secrets configured"
        echo "status=ok" >> $GITHUB_OUTPUT

  test-aws-connection:
    name: ðŸ”— Test AWS Connection
    needs: test-secrets
    runs-on: ubuntu-latest
    if: needs.test-secrets.outputs.secrets-status == 'ok' && github.event.inputs.test_level != 'secrets-only'
    
    steps:
    - name: âš™ï¸ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: ðŸ§ª Test S3 Access
      run: |
        echo "Testing S3 bucket access..."
        if aws s3 ls s3://${{ secrets.S3_BUCKET_NAME }} > /dev/null 2>&1; then
          echo "âœ… S3 bucket accessible: ${{ secrets.S3_BUCKET_NAME }}"
        else
          echo "âŒ Cannot access S3 bucket: ${{ secrets.S3_BUCKET_NAME }}"
          echo "Creating bucket..."
          aws s3 mb s3://${{ secrets.S3_BUCKET_NAME }} --region us-east-1 || echo "Bucket may already exist"
        fi

    - name: ðŸ§ª Test Elastic Beanstalk Access
      run: |
        echo "Testing Elastic Beanstalk access..."
        if aws elasticbeanstalk describe-applications --region us-east-1 > /dev/null 2>&1; then
          echo "âœ… Elastic Beanstalk accessible"
        else
          echo "âŒ Cannot access Elastic Beanstalk"
          exit 1
        fi

  test-backend-build:
    name: ðŸ—ï¸ Test Backend Build
    needs: test-secrets
    runs-on: ubuntu-latest
    if: github.event.inputs.test_level == 'full'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'backend/package-lock.json'

    - name: ðŸ“¦ Install backend dependencies
      working-directory: ./backend
      run: npm ci

    - name: ðŸ§ª Test backend build
      working-directory: ./backend
      run: |
        echo "Testing backend startup..."
        timeout 10s npm start || echo "Backend started successfully"

  test-frontend-build:
    name: ðŸŽ¨ Test Frontend Build
    needs: test-secrets
    runs-on: ubuntu-latest
    if: github.event.inputs.test_level == 'full'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ“¦ Install frontend dependencies
      run: npm ci

    - name: ðŸ—ï¸ Build frontend
      run: npm run build

    - name: ðŸ“ Check build output
      run: |
        echo "Checking build output..."
        ls -la dist/
        echo "âœ… Frontend build successful"

  test-summary:
    name: ðŸ“Š Test Summary
    needs: [test-secrets, test-aws-connection, test-backend-build, test-frontend-build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“‹ Generate Summary
      run: |
        echo "# ðŸ§ª GitHub Actions Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Secrets status
        echo "## ðŸ” Secrets Configuration" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.test-secrets.outputs.secrets-status }}" == "ok" ]; then
          echo "âœ… All required secrets configured" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Missing secrets: ${{ needs.test-secrets.outputs.secrets-status }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # AWS connection
        echo "## ðŸ”— AWS Connection" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.test-aws-connection.result }}" == "success" ]; then
          echo "âœ… AWS connection successful" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.test-aws-connection.result }}" == "skipped" ]; then
          echo "â­ï¸ Skipped (secrets not configured)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ AWS connection failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Backend build
        echo "## ðŸ—ï¸ Backend Build" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.test-backend-build.result }}" == "success" ]; then
          echo "âœ… Backend build successful" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.test-backend-build.result }}" == "skipped" ]; then
          echo "â­ï¸ Skipped (test level: ${{ github.event.inputs.test_level }})" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Backend build failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Frontend build
        echo "## ðŸŽ¨ Frontend Build" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.test-frontend-build.result }}" == "success" ]; then
          echo "âœ… Frontend build successful" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.test-frontend-build.result }}" == "skipped" ]; then
          echo "â­ï¸ Skipped (test level: ${{ github.event.inputs.test_level }})" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Frontend build failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Next steps
        echo "## ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.test-secrets.outputs.secrets-status }}" == "ok" ]; then
          echo "1. âœ… Secrets configured - ready for deployment!" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸš€ Try manual deploy: **Deploy Complete Stack** workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ“ Make changes and push to test automatic deployment" >> $GITHUB_STEP_SUMMARY
        else
          echo "1. ðŸ” Configure missing secrets in repository settings" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ“– Follow instructions in .github/SECRETS_SETUP.md" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ§ª Run this test again after configuration" >> $GITHUB_STEP_SUMMARY
        fi
