name: 🚀 Deploy Frontend to S3

on:
  push:
    tags: ['v*']  # Trigger apenas em TAGs
  workflow_dispatch: # Permite trigger manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: 📦 Install dependencies
      run: npm ci

    - name: 🔧 Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: 🏗️ Build production
      run: |
        # Build com TAG para versionamento
        VITE_VERSION="${{ github.ref_name }}" npm run build
        
        echo "Build completed for version ${{ github.ref_name }}"

    - name: 🚀 Deploy to S3
      run: |
        TAG_NAME="${{ github.ref_name }}"
        
        # Upload principal
        aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_NAME }} --delete
        
        # Backup da versão em releases/
        aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_NAME }}/releases/${TAG_NAME}/ 
        
        echo "✅ Frontend deployed to S3"
        echo "📦 Backup created at releases/${TAG_NAME}/"

    - name: 🔄 Invalidate CloudFront
      run: |
        if [ -n "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
          echo "✅ CloudFront cache invalidated"
        else
          echo "⚠️ CloudFront distribution ID not configured"
        fi

    - name: 📋 Deployment Summary
      run: |
        echo "📋 Frontend Deployment Summary:" >> $GITHUB_STEP_SUMMARY
        echo "- 🌐 **URL**: https://${{ secrets.S3_BUCKET_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- 🏷️ **Version**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- 📦 **Backup**: s3://${{ secrets.S3_BUCKET_NAME }}/releases/${{ github.ref_name }}/" >> $GITHUB_STEP_SUMMARY
