name: ðŸš€ Deploy Frontend to S3

on:
  push:
    tags: ['v*']  # Trigger apenas em TAGs
  workflow_dispatch: # Permite trigger manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸ”§ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: ðŸ—ï¸ Build production
      run: |
        # Build com TAG para versionamento
        VITE_VERSION="${{ github.ref_name }}" npm run build
        
        echo "Build completed for version ${{ github.ref_name }}"

    - name: ðŸš€ Deploy to S3
      run: |
        TAG_NAME="${{ github.ref_name }}"
        
        # Use bucket padrÃ£o se S3_BUCKET_NAME nÃ£o estiver definido
        S3_BUCKET="${{ secrets.S3_BUCKET_NAME }}"
        if [ -z "$S3_BUCKET" ]; then
          S3_BUCKET="radio-importante-frontend"
          echo "âš ï¸ S3_BUCKET_NAME nÃ£o definido, usando bucket padrÃ£o: $S3_BUCKET"
        fi
        
        echo "Deploying to S3 bucket: $S3_BUCKET"
        
        # Verificar se bucket existe, criar se necessÃ¡rio
        if ! aws s3 ls "s3://$S3_BUCKET" 2>/dev/null; then
          echo "ðŸ“¦ Bucket $S3_BUCKET nÃ£o existe, criando..."
          aws s3 mb s3://$S3_BUCKET --region us-west-2
          
          # Configurar bucket para website estÃ¡tico
          aws s3 website s3://$S3_BUCKET --index-document index.html --error-document index.html
          
          # Configurar bucket policy para acesso pÃºblico
          cat > bucket-policy.json << 'EOF'
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "PublicReadGetObject",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::BUCKET_NAME/*"
            }
          ]
        }
        EOF
          
          # Substituir BUCKET_NAME no policy
          sed -i "s/BUCKET_NAME/$S3_BUCKET/g" bucket-policy.json
          
          # Aplicar policy
          aws s3api put-bucket-policy --bucket $S3_BUCKET --policy file://bucket-policy.json
          
          echo "âœ… Bucket criado e configurado para hosting estÃ¡tico"
        fi
        
        # Upload principal
        aws s3 sync dist/ s3://$S3_BUCKET --delete
        
        # Backup da versÃ£o em releases/
        aws s3 sync dist/ s3://$S3_BUCKET/releases/${TAG_NAME}/ 
        
        echo "âœ… Frontend deployed to S3"
        echo "ðŸ“¦ Backup created at releases/${TAG_NAME}/"

    - name: ðŸ”„ Invalidate CloudFront
      run: |
        # Use bucket padrÃ£o se S3_BUCKET_NAME nÃ£o estiver definido
        S3_BUCKET="${{ secrets.S3_BUCKET_NAME }}"
        if [ -z "$S3_BUCKET" ]; then
          S3_BUCKET="radio-importante-frontend"
        fi
        
        if [ -n "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
          echo "âœ… CloudFront cache invalidated"
        else
          echo "âš ï¸ CloudFront distribution ID not configured"
        fi

    - name: ðŸ“‹ Deployment Summary
      run: |
        # Use bucket padrÃ£o se S3_BUCKET_NAME nÃ£o estiver definido
        S3_BUCKET="${{ secrets.S3_BUCKET_NAME }}"
        if [ -z "$S3_BUCKET" ]; then
          S3_BUCKET="radio-importante-frontend"
        fi
        
        echo "ðŸ“‹ Frontend Deployment Summary:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ **URL**: https://$S3_BUCKET.s3-website-us-west-2.amazonaws.com" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ·ï¸ **Version**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ **Backup**: s3://$S3_BUCKET/releases/${{ github.ref_name }}/" >> $GITHUB_STEP_SUMMARY
