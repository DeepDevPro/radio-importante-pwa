<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Console - Radio Importante</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f0f0f0;
    }
    
    .debug-section {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .debug-button {
      background: #007AFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      margin: 5px;
      cursor: pointer;
    }
    
    .debug-output {
      background: #000;
      color: #00ff00;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }
    
    .error { color: #ff4444; }
    .warn { color: #ffaa00; }
    .info { color: #4499ff; }
  </style>
</head>
<body>
    <h1>üêõ Debug Console - Radio Importante</h1>
  
  <!-- Bot√£o para voltar ao player -->
  <div style="margin-bottom: 20px;">
    <button onclick="window.location.href='/'" style="
      background: #271F30;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    ">‚Üê Voltar ao Player</button>
  </div>
  
  <div class="debug-section">
    <h2>üîç Detec√ß√£o de Plataforma</h2>
    <button class="debug-button" onclick="checkPlatform()">Verificar Plataforma</button>
    <button class="debug-button" onclick="checkIOSSpecific()">üçé Verifica√ß√£o iOS Espec√≠fica</button>
    <div id="platform-output" class="debug-output"></div>
  </div>

  <div class="debug-section">
    <h2>üéµ Teste de √Åudio</h2>
    <button class="debug-button" onclick="testAudioBasic()">Teste √Åudio B√°sico</button>
    <button class="debug-button" onclick="testHLS()">Teste HLS</button>
    <div id="audio-output" class="debug-output"></div>
  </div>

  <div class="debug-section">
    <h2>üåê Teste de Rede</h2>
    <button class="debug-button" onclick="testNetwork()">Teste URLs</button>
    <div id="network-output" class="debug-output"></div>
  </div>

  <div class="debug-section">
    <h2>ÔøΩ Teste de APIs e Upload</h2>
    <button class="debug-button" onclick="testAPIs()">Testar APIs</button>
    <button class="debug-button" onclick="testUpload()">Testar Upload</button>
    <button class="debug-button" onclick="checkEnvironment()">Verificar Ambiente</button>
    <div id="api-output" class="debug-output"></div>
  </div>

  <div class="debug-section">
    <h2>ÔøΩüì± Voltar ao App</h2>
    <a href="/" class="debug-button" style="text-decoration: none; display: inline-block;">‚Üê Voltar ao Radio Importante</a>
  </div>

  <script>
    function log(output, message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const element = document.getElementById(output);
      const className = type === 'error' ? 'error' : type === 'warn' ? 'warn' : 'info';
      element.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
      element.scrollTop = element.scrollHeight;
    }

    function checkPlatform() {
      const output = 'platform-output';
      document.getElementById(output).innerHTML = '';
      
      log(output, '=== DETEC√á√ÉO DE PLATAFORMA ===');
      log(output, `User Agent: ${navigator.userAgent}`);
      
      // Detec√ß√£o b√°sica
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isIPhone = /iPhone/.test(navigator.userAgent);
      const isIPad = /iPad/.test(navigator.userAgent);
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || Boolean(navigator.standalone);
      
      log(output, `iOS Device: ${isIOS ? '‚úÖ' : '‚ùå'}`);
      log(output, `iPhone: ${isIPhone ? '‚úÖ' : '‚ùå'}`);
      log(output, `iPad: ${isIPad ? '‚úÖ' : '‚ùå'}`);
      log(output, `PWA Mode: ${isStandalone ? '‚úÖ' : '‚ùå'}`);
      
      // Configura√ß√£o espec√≠fica por dispositivo
      if (isIPhone && isStandalone) {
        log(output, 'üçé CONFIGURA√á√ÉO: iPhone PWA - Aplicar corre√ß√µes espec√≠ficas', 'warn');
      } else if (isIPad && isStandalone) {
        log(output, 'üçé CONFIGURA√á√ÉO: iPad PWA - Usar configura√ß√£o est√°vel', 'info');
      } else if (isIOS) {
        log(output, 'üåê CONFIGURA√á√ÉO: iOS Safari - Configura√ß√£o padr√£o', 'info');
      } else {
        log(output, 'üíª CONFIGURA√á√ÉO: Desktop/Android - Configura√ß√£o padr√£o', 'info');
      }
      
      // Informa√ß√µes adicionais
      log(output, `Window innerWidth: ${window.innerWidth}`);
      log(output, `Window innerHeight: ${window.innerHeight}`);
      log(output, `Screen width: ${screen.width}`);
      log(output, `Screen height: ${screen.height}`);
    }

    function checkIOSSpecific() {
      const output = 'platform-output';
      log(output, '');
      log(output, '=== VERIFICA√á√ÉO iOS ESPEC√çFICA (ROBUSTA) ===');
      
      // Detec√ß√£o granular usando a mesma l√≥gica da nova classe
      const userAgent = navigator.userAgent;
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || Boolean(navigator.standalone);
      const hasIOSFeatures = 'standalone' in navigator || /iPad|iPhone|iPod/.test(userAgent) || (window.DeviceMotionEvent !== undefined && /Mobile|Tablet/.test(userAgent));
      
      const screenWidth = window.screen.width;
      const screenHeight = window.screen.height;
      const maxDimension = Math.max(screenWidth, screenHeight);
      const minDimension = Math.min(screenWidth, screenHeight);
      
      log(output, 'DETEC√á√ÉO ROBUSTA:');
      log(output, 'User Agent: ' + userAgent);
      log(output, 'Has iOS Features: ' + (hasIOSFeatures ? '‚úÖ' : '‚ùå'));
      log(output, 'Screen: ' + screenWidth + 'x' + screenHeight + ' (max: ' + maxDimension + ')');
      log(output, 'Standalone: ' + (isStandalone ? '‚úÖ' : '‚ùå'));
      
      // Nova l√≥gica de detec√ß√£o
      let detectedPlatform = 'Desktop';
      let detectedDevice = 'Desktop';
      
      if (/iPad/.test(userAgent) || (hasIOSFeatures && maxDimension >= 1024)) {
        detectedPlatform = 'iOS';
        detectedDevice = 'iPad';
      } else if (/iPhone|iPod/.test(userAgent) || (hasIOSFeatures && maxDimension < 1024 && minDimension >= 320)) {
        detectedPlatform = 'iOS';
        detectedDevice = 'iPhone';
      } else if (/Android/.test(userAgent)) {
        detectedPlatform = 'Android';
        detectedDevice = 'Android';
      } else if (hasIOSFeatures && isStandalone) {
        detectedPlatform = 'iOS';
        detectedDevice = maxDimension >= 1024 ? 'iPad' : 'iPhone';
      }
      
      log(output, '');
      log(output, 'üéØ DETEC√á√ÉO FINAL:');
      log(output, 'Platform: ' + detectedPlatform, detectedPlatform === 'iOS' ? 'info' : 'warn');
      log(output, 'Device: ' + detectedDevice, detectedDevice.includes('iPhone') ? 'warn' : 'info');
      
      if (detectedDevice === 'iPhone' && isStandalone) {
        log(output, 'üçé DISPOSITIVO: iPhone PWA');
        log(output, 'üîß A√á√ïES IMPLEMENTADAS:', 'info');
        log(output, '  - Priorizar HLS com configura√ß√µes otimizadas');
        log(output, '  - Fallback autom√°tico para MP3 se HLS falhar');
        log(output, '  - preload=metadata ‚Üí auto (evita erro c√≥digo 4)');
        log(output, '  - Timeout e recupera√ß√£o de erro implementados');
        log(output, '‚ö†Ô∏è PROBLEMAS CONHECIDOS:', 'warn');
        log(output, '  - HLS pode gerar erro c√≥digo 4 inicialmente');
        log(output, '  - Sistema tenta HLS primeiro, depois MP3 direto');
      } else if (detectedDevice === 'iPad' && isStandalone) {
        log(output, 'ÔøΩ DISPOSITIVO: iPad PWA');
        log(output, '‚úÖ A√á√ïES RECOMENDADAS:', 'info');
        log(output, '  - Usar configura√ß√£o atual (funcional)');
        log(output, '  - Manter otimiza√ß√µes iOS existentes');
        log(output, '  - Continuar usando HLS se dispon√≠vel');
      } else {
        log(output, 'ÔøΩ DISPOSITIVO: ' + detectedDevice);
        log(output, 'üìã Status: ' + (isStandalone ? 'PWA' : 'Navegador'));
      }
      
      // Verificar APIs espec√≠ficas
      log(output, '');
      log(output, 'üîç APIS DISPON√çVEIS:');
      log(output, 'AudioContext: ' + (window.AudioContext ? '‚úÖ' : '‚ùå'));
      log(output, 'webkitAudioContext: ' + (window.webkitAudioContext ? '‚úÖ' : '‚ùå'));
      log(output, 'Navigator.standalone: ' + (navigator.standalone !== undefined ? '‚úÖ' : '‚ùå'));
      log(output, 'Media Session: ' + (navigator.mediaSession ? '‚úÖ' : '‚ùå'));
      log(output, 'DeviceMotionEvent: ' + (window.DeviceMotionEvent ? '‚úÖ' : '‚ùå'));
      
      // Testar capacidades de √°udio
      const audio = new Audio();
      log(output, '');
      log(output, 'üéµ CAPACIDADES DE √ÅUDIO:');
      log(output, 'Can play MP3: ' + (audio.canPlayType('audio/mpeg') || 'Desconhecido'));
      log(output, 'Can play HLS: ' + (audio.canPlayType('application/vnd.apple.mpegurl') || 'Desconhecido'));
      
      // Informa√ß√µes espec√≠ficas de erro
      if (detectedDevice === 'iPhone') {
        log(output, '');
        log(output, '‚ö†Ô∏è PROBLEMAS CONHECIDOS NO IPHONE:');
        log(output, '- HLS pode gerar erro c√≥digo 4');
        log(output, '- User Agent pode estar mascarado');
        log(output, '- Necess√°rio intera√ß√£o do usu√°rio para √°udio');
        log(output, '- PWA pode pausar em background');
      }
      
      // Retornar info de detec√ß√£o para uso em outros testes
      return detectedDevice;
    }

    function testAudioBasic() {
      const output = 'audio-output';
      document.getElementById(output).innerHTML = '';
      
      log(output, '=== TESTE √ÅUDIO B√ÅSICO ===');
      
      try {
        const audio = new Audio();
        log(output, '‚úÖ Elemento Audio criado');
        
        // Testar URL de √°udio
        const testUrl = '/audio/Para-Entrar.mp3';
        audio.src = testUrl;
        log(output, `üìÅ URL definida: ${testUrl}`);
        
        audio.addEventListener('loadstart', () => {
          log(output, 'üîÑ Carregamento iniciado');
        });
        
        audio.addEventListener('loadedmetadata', () => {
          log(output, `‚úÖ Metadata carregada - Dura√ß√£o: ${audio.duration}s`);
        });
        
        audio.addEventListener('canplay', () => {
          log(output, '‚úÖ Pronto para tocar');
        });
        
        audio.addEventListener('error', () => {
          const error = audio.error;
          log(output, `‚ùå ERRO: C√≥digo ${error?.code} - ${error?.message || 'Desconhecido'}`, 'error');
        });
        
        audio.load();
        log(output, 'üéµ Comando load() executado');
        
      } catch (error) {
        log(output, `‚ùå ERRO na cria√ß√£o: ${error}`, 'error');
      }
    }

    function testHLS() {
      const output = 'audio-output';
      
      log(output, '=== TESTE HLS ===');
      
      try {
        const audio = new Audio();
        log(output, '‚úÖ Elemento Audio criado para HLS');
        
        // Detectar se √© iPhone usando l√≥gica simples e robusta
        const userAgent = navigator.userAgent;
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || Boolean(navigator.standalone);
        const isiPhone = (/iPhone|iPod/.test(userAgent) || 
                         (isStandalone && window.screen && Math.max(window.screen.width, window.screen.height) < 1024));
        
        if (isiPhone) {
          log(output, 'üçé iPhone detectado - aplicando configura√ß√µes espec√≠ficas');
          audio.preload = 'metadata';
          audio.crossOrigin = null;
          audio.loop = false;
          log(output, 'üîß Configura√ß√µes iPhone: preload=metadata, crossOrigin=null');
        }
        
        const hlsUrl = '/audio/hls/playlist-continuous.m3u8';
        log(output, `üìÅ URL HLS definida: ${hlsUrl}`);
        
        audio.addEventListener('loadstart', () => {
          log(output, 'üîÑ HLS - Carregamento iniciado');
        });
        
        audio.addEventListener('loadedmetadata', () => {
          log(output, `‚úÖ HLS - Metadata carregada - Dura√ß√£o: ${audio.duration}s`);
          if (isiPhone) {
            log(output, 'üçé iPhone: Mudando preload para auto ap√≥s metadata');
            audio.preload = 'auto';
          }
        });
        
        audio.addEventListener('canplay', () => {
          log(output, '‚úÖ HLS - Pronto para tocar');
        });
        
        audio.addEventListener('canplaythrough', () => {
          log(output, 'üöÄ HLS - Dados suficientes carregados');
        });
        
        audio.addEventListener('error', () => {
          const error = audio.error;
          const errorCodes = {
            1: 'MEDIA_ERR_ABORTED',
            2: 'MEDIA_ERR_NETWORK', 
            3: 'MEDIA_ERR_DECODE',
            4: 'MEDIA_ERR_SRC_NOT_SUPPORTED'
          };
          
          log(output, `‚ùå HLS ERRO: C√≥digo ${error?.code} - ${errorCodes[error?.code] || 'DESCONHECIDO'}`, 'error');
          log(output, `üìã Mensagem: ${error?.message || 'Sem detalhes'}`, 'error');
          
          if (isiPhone && error?.code === 4) {
            log(output, 'üçé iPhone: Erro c√≥digo 4 detectado - problema comum com HLS no iPhone PWA', 'warn');
            log(output, 'üí° Sugest√£o: Verificar configura√ß√µes do servidor HLS ou usar fallback MP3', 'warn');
          }
        });
        
        audio.addEventListener('stalled', () => {
          log(output, '‚è≥ HLS - Stalled (buffer vazio)', 'warn');
        });
        
        audio.addEventListener('waiting', () => {
          log(output, '‚è≥ HLS - Waiting (aguardando dados)', 'warn');
        });
        
        audio.src = hlsUrl;
        audio.load();
        log(output, 'üéµ HLS - Comando load() executado');
        
      } catch (error) {
        log(output, `‚ùå ERRO HLS: ${error}`, 'error');
      }
    }

    function testNetwork() {
      const output = 'network-output';
      document.getElementById(output).innerHTML = '';
      
      log(output, '=== TESTE DE REDE ===');
      
      const urls = [
        '/audio/Para-Entrar.mp3',
        '/audio/hls/playlist-continuous.m3u8',
        '/audio/hls/track-cues.json'
      ];
      
      urls.forEach(async (url) => {
        try {
          log(output, `üîÑ Testando: ${url}`);
          const response = await fetch(url);
          log(output, `üì° ${url} - Status: ${response.status} ${response.statusText}`, response.ok ? 'info' : 'error');
          
          if (url.endsWith('.json')) {
            const data = await response.json();
            log(output, `üìÑ JSON: ${JSON.stringify(data).substring(0, 100)}...`);
          }
        } catch (error) {
          log(output, `‚ùå ERRO: ${url} - ${error}`, 'error');
        }
      });
    }

    function checkEnvironment() {
      const output = 'api-output';
      document.getElementById(output).innerHTML = '';
      
      log(output, '=== VERIFICA√á√ÉO DE AMBIENTE ===');
      log(output, `Host: ${window.location.hostname}`);
      log(output, `Port: ${window.location.port}`);
      log(output, `Protocol: ${window.location.protocol}`);
      log(output, `URL completa: ${window.location.href}`);
      
      const isProduction = !window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1');
      log(output, `Ambiente: ${isProduction ? 'PRODU√á√ÉO (S3)' : 'DESENVOLVIMENTO (Vite)'}`, isProduction ? 'warn' : 'info');
      
      if (isProduction) {
        log(output, '‚ö†Ô∏è Em produ√ß√£o: APIs n√£o dispon√≠veis', 'warn');
        log(output, 'üí° Upload requer configura√ß√£o de backend separado', 'info');
      } else {
        log(output, '‚úÖ Em desenvolvimento: APIs dispon√≠veis via Vite', 'info');
      }
    }

    function testAPIs() {
      const output = 'api-output';
      document.getElementById(output).innerHTML = '';
      
      log(output, '=== TESTE DE APIs ===');
      
      const isProduction = !window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1');
      
      if (isProduction) {
        log(output, '‚ö†Ô∏è Modo produ√ß√£o: APIs n√£o dispon√≠veis no S3', 'warn');
        log(output, 'üìã Endpoints que precisariam de backend:', 'info');
        log(output, '  - POST /api/upload', 'info');
        log(output, '  - POST /api/save-catalog', 'info');
        log(output, '  - POST /api/regenerate-catalog', 'info');
        return;
      }
      
      // Teste das APIs em desenvolvimento
      const apis = [
        { url: '/api/save-catalog', method: 'POST', data: { test: true } },
      ];
      
      apis.forEach(async (api) => {
        try {
          log(output, `üîÑ Testando: ${api.method} ${api.url}`);
          const response = await fetch(api.url, {
            method: api.method,
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(api.data)
          });
          
          const result = await response.text();
          log(output, `üì° ${api.url} - Status: ${response.status}`, response.ok ? 'info' : 'error');
          log(output, `üìÑ Response: ${result.substring(0, 200)}...`);
          
        } catch (error) {
          log(output, `‚ùå ERRO: ${api.url} - ${error}`, 'error');
        }
      });
    }

    function testUpload() {
      const output = 'api-output';
      log(output, '');
      log(output, '=== TESTE DE UPLOAD ===');
      
      const isProduction = !window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1');
      
      if (isProduction) {
        log(output, '‚ö†Ô∏è Upload n√£o dispon√≠vel em produ√ß√£o (S3 est√°tico)', 'warn');
        log(output, 'üí° Solu√ß√µes poss√≠veis:', 'info');
        log(output, '  1. AWS Lambda + API Gateway', 'info');
        log(output, '  2. Backend separado (Node.js/Express)', 'info');
        log(output, '  3. Cliente desktop para upload', 'info');
        return;
      }
      
      // Criar um arquivo de teste pequeno
      const testData = {
        filename: 'test-upload.mp3',
        fileData: btoa('fake-audio-data-for-testing') // base64 fake
      };
      
      log(output, 'üîÑ Enviando arquivo de teste...');
      
      fetch('/api/upload', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(testData)
      })
      .then(response => response.json())
      .then(result => {
        log(output, `‚úÖ Upload teste: ${JSON.stringify(result)}`, 'info');
      })
      .catch(error => {
        log(output, `‚ùå Erro no upload teste: ${error}`, 'error');
      });
    }

    // Auto-executar detec√ß√£o de plataforma
    setTimeout(checkPlatform, 500);
  </script>
</body>
</html>
